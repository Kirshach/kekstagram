(()=>{"use strict";(()=>{const e=(e,t,o)=>{const n=e.cloneNode(!0),r=n.querySelector(".picture__img"),i=n.querySelector(".picture__likes"),a=n.querySelector(".picture__comments");return n.dataset.index=o,r.src=t.url,i.textContent=t.likes,a.textContent=t.comments.length,n},t=e=>{"Escape"===e.key&&(e.preventDefault(),(window.pageMainNode.querySelector(".success")||window.pageMainNode.querySelector(".error")).remove(),window.toggleNotificationListeners("off"))},o=e=>{const t=window.pageMainNode.querySelector(".success")||window.pageMainNode.querySelector(".error");e.target!==t&&e.target!==t.querySelector("button")||(t.remove(),window.toggleNotificationListeners("off"))};window.pageMainNode=document.querySelector("main"),window.successTemplate=document.querySelector("#success"),window.errorTemplate=document.querySelector("#error"),window.picturesContainerNode=document.querySelector(".pictures"),window.pictureTemplate=document.querySelector("#picture").content.querySelector(".picture"),window.filters={filtersNode:document.querySelector(".img-filters")},window.generateDomPicturesFragment=t=>{const o=document.createDocumentFragment();for(let n=0;n<t.length;n++){const r=e(window.pictureTemplate,t[n],n);o.appendChild(r)}return o},window.toggleNotificationListeners=e=>{const n="on"===e?"addEventListener":"removeEventListener";document[n]("keydown",t),document[n]("click",o)},window.sendXMLHttpRequest=(e,t,o,n,r,i,a)=>{const s=new XMLHttpRequest;s.open(t,e),s.timeout=i,s.addEventListener("load",(()=>o(s))),s.addEventListener("error",n),s.addEventListener("timeout",r),s.send(a)},window.debounceFunction=(e,t)=>{let o;return(...n)=>{o&&clearTimeout(o),o=setTimeout((()=>{e(...n)}),t)}}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".img-upload__scale"),o=e.querySelector(".img-upload__effect-level"),n=o.querySelector(".effect-level__line"),r=e.querySelector(".img-upload__preview img");window.uploadForm={overlayNode:e,imagePreview:r,effectsSliderNode:o,effectsLineNode:n,effectsPinNode:n.querySelector(".effect-level__pin"),effectsValueNode:o.querySelector(".effect-level__value"),scaleFieldSetNode:t,scaleSmallerNode:t.querySelector(".scale__control--smaller"),scaleBiggerNode:t.querySelector(".scale__control--bigger"),commentInputNode:e.querySelector(".text__description")}})(),(()=>{const e={chrome:{min:0,max:1,name:"grayscale",unit:""},sepia:{min:0,max:1,name:"sepia",unit:""},marvin:{min:0,max:100,name:"invert",unit:"%"},phobos:{min:0,max:3,name:"blur",unit:"px"},heat:{min:1,max:3,name:"brightness",unit:""}},{uploadForm:t}=window,{overlayNode:o,effectsSliderNode:n,effectsLineNode:r,effectsPinNode:i,effectsValueNode:a,scaleFieldSetNode:s,scaleSmallerNode:c,scaleBiggerNode:d}=t,{imagePreview:l}=window.uploadForm,u=o.querySelector(".effect-level__depth"),m=s.querySelector(".scale__control--value"),p=()=>{g(null,100)},w=()=>{y(null,"none")},f=()=>{i.style.left="100%",u.style.width="100%",a.value=100},g=(e,t)=>{let o;t?o=t+"%":e.target===c?o=Math.max(parseInt(m.value,10)-25,25)+"%":e.target===d&&(o=Math.min(parseInt(m.value,10)+25,100)+"%"),m.value=o,l.style.transform=`scale(${parseInt(m.value,10)/100})`},y=(e,t)=>{let o=t||e.target.value;l.className="effects__preview--"+o,l.dataset.effect=o,v(100),h(),f(),"none"===o?n.classList.add("hidden"):n.classList.contains("hidden")&&n.classList.remove("hidden")},v=e=>{a.value=e},h=()=>{const t=l.dataset.effect,o=a.value;l.style.filter=((t,o)=>{let n;if("none"!==t){const r=e[t];n=`${r.name}(${(r.max-r.min)*(o/100)+r.min}${r.unit})`}else n="none";return n})(t,o)};window.uploadForm.photoEdit={resetScale:p,resetEffects:w,resetSlider:f,clearFormData:()=>{p(),w(),f()},setScale:g,setEffectType:y,applyEffect:h,movePin:e=>{e.preventDefault();const t=i.offsetLeft,o=r.offsetWidth,n=e.clientX,a=r=>{e.stopPropagation();const a=r.clientX-n,s=Math.min(Math.max(0,t+a),o);i.style.left=s+"px",u.style.width=s+"px",v(Math.round(s/o*100)),h()},s=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",s)}}})(),(()=>{const e="хэштег должен содержать хотя бы одну букву или цифру",{overlayNode:t,commentInputNode:o}=window.uploadForm,n=t.querySelector(".text__hashtags"),r=e=>{n.style.borderColor=e?"":"#cd3300"};window.uploadForm.validation={getHashtagsValidityMessage:()=>{const t=n.value.toLowerCase().split(" ").filter((e=>""!==e));let o=new Set;return((e,t)=>{e.length>5&&t.add("можно указать не более 5 хэштегов")})(t,o),((t,o)=>{t.includes("#")&&t.length>1&&t.indexOf("#")!==t.length-1&&o.add(e)})(t,o),((e,t)=>{e.forEach((o=>{(e=>{const t=new Set;return""===e?[]:(e.startsWith("#")||t.add('хэштег должен начинаться с символа "#"'),/^[а-яa-z1-9#]+$/i.test(e)||t.add("хэштег должен содержать только буквы и цифры"),e.indexOf("#")!==e.lastIndexOf("#")?t.add("хэштеги должны быть разделены пробелом"):e.length>20&&t.add("максимальная длина хэштега - 20 символов"),t)})(o).forEach((e=>t.add(e))),e.indexOf(o)!==e.lastIndexOf(o)&&"#"!==o&&t.add("хэштеги не должны повторяться")}))})(t,o),Array.from(o).join(", ")},checkCommentValidity:()=>{o.value.length>=140?(o.setCustomValidity("Длина комментария не должна превышать 140 символов"),o.reportValidity()):o.setCustomValidity("")},checkFormValidity:t=>n.value.toLowerCase().split(" ").filter((e=>" "!==e)).includes("#")?(t.preventDefault(),n.setCustomValidity(e),n.reportValidity(),r(!1),!1):(r(!0),!0),reportHashtagsValidity:e=>{n.setCustomValidity(e.slice(0,1).toUpperCase()+e.slice(1)),n.reportValidity(),r(""===e)}}})(),(()=>{const{overlayNode:e,imagePreview:t,effectsValueNode:o,scaleSmallerNode:n,scaleBiggerNode:r,commentInputNode:i}=window.uploadForm,{clearFormData:a,setScale:s,setEffectType:c,applyEffect:d,movePin:l}=window.uploadForm.photoEdit,{getHashtagsValidityMessage:u,checkCommentValidity:m,checkFormValidity:p,reportHashtagsValidity:w}=window.uploadForm.validation,f=document.querySelector("#upload-file"),g=document.querySelector(".img-upload__form"),y=e.querySelector("#upload-cancel"),v=e.querySelector(".img-upload__effects"),h=document.querySelector(".text__hashtags"),_=[h,i],S=e=>{"Escape"!==e.key||_.includes(document.activeElement)||I()},q=e=>{const t=(e?window.successTemplate:window.errorTemplate).content.cloneNode(!0);window.pageMainNode.appendChild(t),window.toggleNotificationListeners("on")},L=e=>{const t=e.status<400;q(t),I()},N=()=>{q(!1),I()},x=()=>{q(!1),I()},E=e=>{s(e)},C=e=>{s(e)},D=e=>{c(e)},k=()=>{d()},F=e=>{l(e)},b=()=>{const e=u();w(e)},M=e=>{p(e)},P=e=>{var t;e.preventDefault(),t=new FormData(g),window.sendXMLHttpRequest("https://21.javascript.pages.academy/kekstagram","POST",L,N,x,7e3,t)},V=()=>{m()},T=()=>{I()},H=e=>{const t=e?"addEventListener":"removeEventListener";n[t]("click",E),r[t]("click",C),v[t]("change",D),o[t]("change",k),window.uploadForm.effectsPinNode[t]("mousedown",F),h[t]("input",b),h[t]("blur",M),g[t]("submit",P),i[t]("input",V),y[t]("click",T),document[t]("keydown",S)},I=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),f.value="",H(!1)};f.addEventListener("change",(()=>{(()=>{a();const o=new FileReader;o.addEventListener("load",(o=>{t.src=o.target.result,e.classList.remove("hidden"),document.body.classList.add("modal-open"),H(!0)})),o.readAsDataURL(f.files[0])})()}))})(),(()=>{window.filteredPicturesData=[];const{picturesContainerNode:e,generateDomPicturesFragment:t}=window,o=e=>{const t=Math.floor(Math.random()*e.length);return e.splice(t,1)},n={"filter-default":()=>(window.filteredPicturesData=window.picturesData,t(window.picturesData)),"filter-random":()=>{const e=[],n=[...window.picturesData];for(let t=0;t<10;t++){const t=o(n)[0];e.push(t)}return window.filteredPicturesData=e,t(e)},"filter-discussed":()=>{const e=[...window.picturesData].sort(((e,t)=>t.comments.length-e.comments.length));return window.filteredPicturesData=e,t(e)}},r=window.debounceFunction((t=>{const{target:o}=t,r=o.parentNode.querySelector(".img-filters__button--active"),i=(0,n[o.id])();(()=>{const t=e.querySelector(".img-upload");for(;t.nextSibling;)t.nextSibling.remove()})(),e.appendChild(i),r.classList.remove("img-filters__button--active"),o.classList.add("img-filters__button--active")}),500);window.filters.addListener=function(){this.filtersNode.querySelector(".img-filters__form").addEventListener("click",r)}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img "),o=e.querySelector(".likes-count"),n=e.querySelector(".social__comments"),r=e.querySelector(".social__caption"),i=e.querySelector(".social__comment-count"),a=i.querySelector(".comments-count"),s=e.querySelector(".comments-loader"),c=e.querySelector(".big-picture__cancel"),{picturesContainerNode:d,generateDomPicturesFragment:l}=window;let u;const m=document.querySelector(".social__comment").cloneNode(!0),p=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),y("off")},w=()=>{const e=(()=>{const e=window.filteredPicturesData[u].comments;let t=n.children.length;const o=Math.min(t+5,e.length),r=[];for(;t<o;t+=1)r.push(e[t]);return r})();v(e)},f=()=>{p()},g=e=>{"Escape"===e.key&&p()},y=e=>{const t="on"===e?"addEventListener":"removeEventListener";c[t]("click",f),s[t]("click",w),document[t]("keydown",g)},v=e=>{const t=(e=>{const t=document.createDocumentFragment();for(let o=0;o<e.length;o+=1){const n=e[o],r=m.cloneNode(!0),i=r.querySelector(".social__picture"),a=r.querySelector(".social__text");i.src=n.avatar,i.alt=n.name,i.width=35,i.height=35,a.textContent=n.message,t.appendChild(r)}return t})(e);n.appendChild(t);const o=window.filteredPicturesData[u].comments.length;n.children.length>=o?s.classList.add("hidden"):s.classList.remove("hidden"),i.childNodes[0].data=n.children.length+" из "},h=i=>{(i=>{const s=i.composedPath()[1];if(!s.classList.contains("picture"))return;u=s.dataset.index,n.innerHTML="";const c=window.filteredPicturesData[u],d=c.comments.slice(0,5);v(d),t.src=c.url,o.textContent=c.likes,r.textContent=c.description,a.textContent=c.comments.length,e.classList.remove("hidden"),document.body.classList.add("modal-open"),y("on")})(i)},_=e=>{const t=window.errorTemplate.content.cloneNode(!0);t.querySelector(".error__title").textContent=e,t.querySelector(".error__button").textContent="Понятно ;(",window.pageMainNode.appendChild(t),window.toggleNotificationListeners("on")};window.sendXMLHttpRequest("https://21.javascript.pages.academy/kekstagram/data","GET",(e=>{e.status<400?(window.filteredPicturesData=window.picturesData=JSON.parse(e.response),(e=>{const t=l(e);d.appendChild(t),d.addEventListener("click",h)})(window.picturesData),window.filters.filtersNode.classList.remove("img-filters--inactive"),window.filters.addListener()):_("Что-то пошло не так 😱")}),(()=>_("Ошибка соединения 🤪")),(()=>_("Ваше время истекло 💀")),7e3)})()})();