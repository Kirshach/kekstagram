(()=>{"use strict";(()=>{const e=(e,t,n)=>{const o=e.cloneNode(!0),i=o.querySelector(".picture__img"),r=o.querySelector(".picture__likes"),c=o.querySelector(".picture__comments");return o.dataset.index=n,i.src=t.url,r.textContent=t.likes,c.textContent=t.comments.length,o},t=function(e){"Escape"===e.key&&(e.preventDefault(),(window.pageMainNode.querySelector(".success")||window.pageMainNode.querySelector(".error")).remove(),window.toggleNotificationListeners("off"))},n=function(e){const t=window.pageMainNode.querySelector(".success")||window.pageMainNode.querySelector(".error");e.target!==t&&e.target!==t.querySelector("button")||(t.remove(),window.toggleNotificationListeners("off"))};window.pageMainNode=document.querySelector("main"),window.successTemplate=document.querySelector("#success"),window.errorTemplate=document.querySelector("#error"),window.picturesContainerNode=document.querySelector(".pictures"),window.pictureTemplate=document.querySelector("#picture").content.querySelector(".picture"),window.filters={filtersNode:document.querySelector(".img-filters")},window.generateDomPicturesFragment=t=>{const n=document.createDocumentFragment();for(let o=0;o<t.length;o++){const i=e(window.pictureTemplate,t[o],o);n.appendChild(i)}return n},window.toggleNotificationListeners=function(e){const o="on"===e?"addEventListener":"removeEventListener";document[o]("keydown",t),document[o]("click",n)}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".img-upload__scale"),n=e.querySelector(".img-upload__effect-level"),o=n.querySelector(".effect-level__line"),i=e.querySelector(".img-upload__preview img");window.uploadForm={overlayNode:e,imagePreview:i,effectsSliderNode:n,effectsLineNode:o,effectsPinNode:o.querySelector(".effect-level__pin"),effectsValueNode:n.querySelector(".effect-level__value"),scaleFieldSetNode:t,scaleSmallerNode:t.querySelector(".scale__control--smaller"),scaleBiggerNode:t.querySelector(".scale__control--bigger"),commentInputNode:e.querySelector(".text__description")}})(),(()=>{const e={chrome:{min:0,max:1,name:"grayscale",unit:""},sepia:{min:0,max:1,name:"sepia",unit:""},marvin:{min:0,max:100,name:"invert",unit:"%"},phobos:{min:0,max:3,name:"blur",unit:"px"},heat:{min:1,max:3,name:"brightness",unit:""}},{uploadForm:t}=window,{overlayNode:n,effectsSliderNode:o,effectsLineNode:i,effectsPinNode:r,effectsValueNode:c,scaleFieldSetNode:a,scaleSmallerNode:s,scaleBiggerNode:l}=t,{imagePreview:d}=window.uploadForm,u=n.querySelector(".effect-level__depth"),m=a.querySelector(".scale__control--value"),f=function(){g(null,100)},p=function(){y(null,"none")},w=function(){r.style.left="100%",u.style.width="100%",c.value=100},g=function(e,t){let n;t?n=t+"%":e.target===s?n=Math.max(parseInt(m.value,10)-25,25)+"%":e.target===l&&(n=Math.min(parseInt(m.value,10)+25,100)+"%"),m.value=n,d.style.transform=`scale(${parseInt(m.value,10)/100})`},y=function(e,t){let n=t||e.target.value;d.className="effects__preview--"+n,d.dataset.effect=n,v(100),h(),w(),"none"===n?o.classList.add("hidden"):o.classList.contains("hidden")&&o.classList.remove("hidden")},v=function(e){c.value=e},h=function(){const t=d.dataset.effect,n=c.value;d.style.filter=function(t,n){let o;if("none"!==t){const i=e[t];o=`${i.name}(${(i.max-i.min)*(n/100)+i.min}${i.unit})`}else o="none";return o}(t,n)};window.uploadForm.photoEdit={resetScale:f,resetEffects:p,resetSlider:w,resetForm:function(){f(),p(),w()},setScale:g,setEffectType:y,applyEffect:h,movePin:function(e){e.preventDefault();const t=r.offsetLeft,n=i.offsetWidth,o=e.clientX,c=function(i){e.stopPropagation();const c=i.clientX-o,a=Math.min(Math.max(0,t+c),n);r.style.left=a+"px",u.style.width=a+"px",v(Math.round(a/n*100)),h()},a=function(){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",a)}}})(),(()=>{const{overlayNode:e,commentInputNode:t}=window.uploadForm,n=e.querySelector(".text__hashtags"),o=function(e){n.style.borderColor=e?"":"#cd3300"},i=function(e){const t=new Set;return""===e?[]:(e.startsWith("#")||t.add('хэштег должен начинаться с символа "#"'),/^[а-яa-z1-9#]+$/i.test(e)||t.add("хэштег должен содержать только буквы и цифры"),e.indexOf("#")!==e.lastIndexOf("#")?t.add("хэштеги должны быть разделены пробелом"):e.length>20&&t.add("максимальная длина хэштега - 20 символов"),t)};window.uploadForm.validation={checkHashtagsValidity:function(){const e=n.value.toLowerCase().split(" ").filter((e=>""!==e));let t=new Set;e.length>5&&t.add("можно указать не более 5 хэштегов"),e.includes("#")&&e.length>1&&e.indexOf("#")!==e.length-1&&t.add("хэштег должен содержать хотя бы одну букву или цифру");for(let n=0;n<e.length;n+=1){const o=e[n];i(o).forEach((e=>t.add(e))),e.indexOf(o)!==e.lastIndexOf(o)&"#"!==o&&t.add("хэштеги не должны повторяться")}let r=Array.from(t).join(", ");n.setCustomValidity(r.slice(0,1).toUpperCase()+r.slice(1)),n.reportValidity(),o(""===r)},checkCommentValidity:function(){t.value.length>=140?(t.setCustomValidity("Длина комментария не должна превышать 140 символов"),t.reportValidity()):t.setCustomValidity("")},checkFormValidity:function(e){return n.value.toLowerCase().split(" ").filter((e=>" "!==e)).includes("#")?(e.preventDefault(),n.setCustomValidity("Хэштег должен содержать хотя бы одну букву или цифру"),n.reportValidity(),o(!1),!1):(o(!0),!0)}}})(),(()=>{const{overlayNode:e,imagePreview:t,effectsValueNode:n,scaleSmallerNode:o,scaleBiggerNode:i,commentInputNode:r}=window.uploadForm,{resetForm:c,setScale:a,setEffectType:s,applyEffect:l,movePin:d}=window.uploadForm.photoEdit,{checkHashtagsValidity:u,checkCommentValidity:m,checkFormValidity:f}=window.uploadForm.validation,p=document.querySelector("#upload-file"),w=document.querySelector(".img-upload__form"),g=e.querySelector("#upload-cancel"),y=e.querySelector(".img-upload__effects"),v=document.querySelector(".text__hashtags"),h=[v,r],_=function(e){"Escape"!==e.key||h.includes(document.activeElement)||L()},S=function(e){const t=e?"addEventListener":"removeEventListener";o[t]("click",a),i[t]("click",a),y[t]("change",s),n[t]("change",l),window.uploadForm.effectsPinNode[t]("mousedown",d),v[t]("input",u),v[t]("blur",f),w[t]("submit",N),r[t]("input",m),g[t]("click",L),document[t]("keydown",_)},L=function(){e.classList.add("hidden"),document.body.classList.remove("modal-open"),p.value="",S(!1)},q=function(e){const t=(e?window.successTemplate:window.errorTemplate).content.cloneNode(!0);L(),window.pageMainNode.appendChild(t),window.toggleNotificationListeners("on")},N=function(e){e.preventDefault();const t=new FormData(w);let n=new XMLHttpRequest;n.addEventListener("load",(function(){q(n.status<400)})),n.addEventListener("error",(function(){q(!1)})),n.addEventListener("timeout",(function(){q(!1)})),n.open("POST","https://21.javascript.pages.academy/kekstagram"),n.send(t)};p.addEventListener("change",(function(){!function(){c();const n=new FileReader;n.addEventListener("load",(n=>{t.src=n.target.result,e.classList.remove("hidden"),document.body.classList.add("modal-open"),S(!0)})),n.readAsDataURL(p.files[0])}()}))})(),(()=>{window.filteredPicturesData=[];const{picturesContainerNode:e,generateDomPicturesFragment:t}=window,n=function(e){const t=Math.floor(Math.random()*e.length);return e.splice(t,1)},o={"filter-default":function(){return window.filteredPicturesData=window.picturesData,t(window.picturesData)},"filter-random":function(){const e=[],o=[...window.picturesData];for(let t=0;t<10;t++){const t=n(o)[0];e.push(t)}return window.filteredPicturesData=e,t(e)},"filter-discussed":function(){const e=[...window.picturesData].sort(((e,t)=>t.comments.length-e.comments.length));return window.filteredPicturesData=e,t(e)}};let i;window.filters.addListener=function(){this.filtersNode.querySelector(".img-filters__form").addEventListener("click",(t=>{i&&clearTimeout(i),i=setTimeout((function(){!function(t){const{target:n}=t,i=n.parentNode.querySelector(".img-filters__button--active"),r=(0,o[n.id])();!function(){const t=e.querySelector(".img-upload");for(;t.nextSibling;)t.nextSibling.remove()}(),e.appendChild(r),i.classList.remove("img-filters__button--active"),n.classList.add("img-filters__button--active")}(t)}),500)}))}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img "),n=e.querySelector(".likes-count"),o=e.querySelector(".social__comments"),i=e.querySelector(".social__caption"),r=e.querySelector(".social__comment-count"),c=r.querySelector(".comments-count"),a=e.querySelector(".comments-loader"),s=e.querySelector(".big-picture__cancel"),{picturesContainerNode:l,generateDomPicturesFragment:d}=window;let u;const m=document.querySelector(".social__comment").cloneNode(!0),f=function(){e.classList.add("hidden"),document.body.classList.remove("modal-open"),w("off")},p=function(e){"Escape"===e.key&&f()},w=function(e){const t="on"===e?"addEventListener":"removeEventListener";s[t]("click",f),a[t]("click",y),document[t]("keydown",p)},g=function(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n+=1){const o=e[n],i=m.cloneNode(!0),r=i.querySelector(".social__picture"),c=i.querySelector(".social__text");r.src=o.avatar,r.alt=o.name,r.width=35,r.height=35,c.textContent=o.message,t.appendChild(i)}o.appendChild(t);const n=window.filteredPicturesData[u].comments.length;o.children.length>=n?a.classList.add("hidden"):a.classList.remove("hidden"),r.childNodes[0].data=o.children.length+" из "},y=function(){const e=window.filteredPicturesData[u].comments;let t=o.children.length;const n=Math.min(t+5,e.length),i=[];for(;t<n;t+=1)i.push(e[t]);g(i)},v=function(r){const a=r.composedPath()[1];if(!a.classList.contains("picture"))return;u=a.dataset.index,o.innerHTML="";const s=window.filteredPicturesData[u],l=s.comments.slice(0,5);g(l),t.src=s.url,n.textContent=s.likes,i.textContent=s.description,c.textContent=s.comments.length,e.classList.remove("hidden"),document.body.classList.add("modal-open"),w("on")},h=function(e){const t=window.errorTemplate.content.cloneNode(!0);t.querySelector(".error__title").textContent=e,t.querySelector(".error__button").textContent="Понятно ;(",window.pageMainNode.appendChild(t),window.toggleNotificationListeners("on")},_=new XMLHttpRequest;_.open("GET","https://21.javascript.pages.academy/kekstagram/data"),_.timeout=7e3,_.addEventListener("load",(function(){_.status<400?(window.filteredPicturesData=window.picturesData=JSON.parse(_.response),function(e){const t=d(e);l.appendChild(t),l.addEventListener("click",v)}(window.picturesData),window.filters.filtersNode.classList.remove("img-filters--inactive"),window.filters.addListener()):h("Что-то пошло не так 😱")})),_.addEventListener("error",h.bind(null,"Ошибка соединения 🤪")),_.addEventListener("timeout",h.bind(null,"Ваше время истекло 💀")),_.send()})()})();